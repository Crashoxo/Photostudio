(function($,window){"use strict";var Signin=function(){var now_days,total_days,times,mod_day,lightbox,finishedAd,order=[["7","7day.svg","reword-progress-node"],["14","14day.svg","sec"],["21","21day.svg","third"],["28","badge.svg","fourth"]],dialogInfo={7:{modDay:"7",image:"7day.svg",text:"獲得加碼獎勵<br /> 500 巴幣"},14:{modDay:"14",image:"14day.svg",text:"獲得加碼獎勵<br /> 500 巴幣"},21:{modDay:"21",image:"21day.svg",text:"獲得加碼獎勵<br /> 500 巴幣"},28:{modDay:"28",image:"badge.svg",text:"+ 500 巴幣 & 勳章<br>（斷簽會回收勳章！）<br>連續簽到一年就能帶走永久勳章！"},365:{modDay:"365",image:"365days.svg",text:"恭喜你獲得永久勳章！"}},dialog;var dailyProgress=function(){var content,week;content='<div class="daily-progress-wrap">';content+='<div class="reword-progress-wrap">';content+='<div class="reword-progress">';for(var i=0;i<4;i++){week=i+1;if(week>times||week==times&&mod_day==0){content+='<div class="reword-progress-node '+order[i][2]+'">'}else{content+='<div class="reword-progress-node is-active '+order[i][2]+'">'}content+='<div class="reword-content">';content+='<div class="daily-img" style="background-image: url(https://i2.bahamut.com.tw/dailyBonus/'+order[i][1]+');"></div>';content+='<div class="daily-num">'+order[i][0]+" 天</div>";content+="</div></div>"}var progressRate=0;if(mod_day===0){progressRate=times*25}else if(mod_day>0){progressRate=times*25+mod_day*3.5}content+='<div class="reword-progress-bar" style="width: '+progressRate+'%;"></div>';content+="</div></div>";content+='<div class="daily-tips mobile-tip">';content+="<p>已連續簽到 "+total_days+" 天</p>";content+='<div class="anni-bonus">連續簽到 365 天，週年<span>永久勳章</span>等你哦<img class="anni-bonus__badge" src="https://i2.bahamut.com.tw/dailyBonus/sign-in_badge.gif"></div>';content+="</div>";content+="</div>";return content};var progressAnime=function(){var start,end,isSeven=false;if(mod_day==0){start=(times-1)*25+6*3.5;end=times*25;isSeven=true}else{start=times*25+(mod_day-1)*3.5;end=times*25+mod_day*3.5}$(".reword-progress-bar").width(start+"%");setTimeout(function(){$(".reword-progress-bar").width(end+"%")},850);if(isSeven){$(".reword-progress-bar").on("transitionend",function(){$("."+order[times-1][2]).eq(0).addClass("is-active")})}};var bonusMonth=function(){var content,image,bonus,sequenceDay=0;content='<div class="bonus-month">';content+='<ul class="row grid-7 bonus-month__content">';for(var day=1;day<=7;day++){content+='<li class="col"><div class="daily-num bonus-month-title">'+day+"</div></li>"}for(var week=0;week<4;week++){for(var day=1;day<8;day++){sequenceDay=week*7+day;content+='<li class="col col-padding">';content+='<div class="bonus-day" id="day-'+sequenceDay+'">';content+='<div class="daily-check"></div>';if(day==7){if(week==3){bonus='<span class="coin-unit">勇者</span><span class="coin">勳章</span>'}else{bonus='<span class="coin">500</span> <span class="coin-unit">巴幣</span>'}image=order[week][0];content+='<div class="daily-img" style="background-image: url(https://i2.bahamut.com.tw/dailyBonus/'+order[week][1]+');"></div>';content+='<div class="daily-num">'+bonus+"</div>"}else{var gold=100;content+='<div class="daily-img" style="background-image: url(https://i2.bahamut.com.tw/dailyBonus/coin.svg);"></div>';content+='<div class="daily-num"><span class="coin">'+gold+'</span> <span class="coin-unit">巴幣</span></div>'}content+="</div><li>"}}content+="</ul>";content+="</div>";return content};var bonusCard=function(){var content='<div class="bonus-card-mask">';content+='<div class="bonus-card">';content+='<div class="daily-img card-img" style="background-image: url(https://i2.bahamut.com.tw/dailyBonus/'+dialogInfo[dialog].image+');"></div>';content+='<div class="bonus-card__title">連續 '+dialogInfo[dialog].modDay+" 天簽到</div>";content+='<div class="bonus-card__desc">'+dialogInfo[dialog].text+"</div>";content+='<div class="bonus-seal"></div>';content+="</div>";return content};var bonusAnime=function(){$(".popup-wrap").after(bonusCard());setTimeout(function(){$(".popup-bg").addClass("is-hide");$(".bonus-card-mask").addClass("is-show");$("body").css("overflow","hidden")},1e3);setTimeout(function(){$(".bonus-seal").addClass("is-show")},2e3);setTimeout(function(){$(".bonus-card-mask").removeClass("is-show");$(".popup-bg").removeClass("is-hide");$("body").css("overflow","auto")},8e3)};var close=function(){$(".popoup-close, .bonus-card-mask").unbind();$(".bonus-card-mask").remove();lightbox.close()};var getCsrfToken=function(){var url="";if(location.host=="m.gamer.com.tw"){url="/ajax/MB_getCSRFToken.php"}else if(location.host=="www.gamer.com.tw"){url="/ajax/get_csrf_token.php"}return $.ajax({url:url,cache:false})};var openSigninMap=function(element,ver){var header,body,footer;times=Math.floor(now_days/7);mod_day=now_days%7;header='<div class="daily-title">';header+='<h3 class="daily-title__text">每日簽到</h3>';header+="</div>";body=dailyProgress()+bonusMonth();footer='<div class="daily-prompt">';footer+='<div class="daily-prompt_imgbox">';footer+='<img class="daily-prompt_imgdesktop" src="https://i2.bahamut.com.tw/dailyBonus/ad-c1.png">';footer+='<img class="daily-prompt_imgmobile" src="https://i2.bahamut.com.tw/dailyBonus/ad-c2.png">';footer+='<img class="daily-prompt_imgbabi" src="https://i2.bahamut.com.tw/dailyBonus/coin.svg" alt="巴幣">';footer+="</div>";footer+="</div>";footer+='<div class="modal-ctrl">';if(finishedAd===1){footer+='<a role="button" class="popoup-ctrl-btn is-disable">已領取雙倍簽到獎勵</a>'}else{footer+='<a role="button" class="popoup-ctrl-btn" onclick="window.SigninAd.startAd();">觀看廣告領取雙倍巴幣</a>'}footer+="</div>";lightbox=$(element).lightBox({header:header,headerClass:"daily-header",body:body,bodyClass:"daily-body",footer:footer,footerClass:"modal__footer--bonus",modalClass:"daily-modal"});lightbox.open();if(mod_day===0){$("."+order[times-1][2]).eq(0).addClass("is-active")}$(".popoup-close, .bonus-card-mask").click(function(){close()});if(ver=="act"){for(var i=1;i<29;i++){if(now_days>i){$("#day-"+i).addClass("is-active")}else if(now_days==i){$("#day-"+i).addClass("before-active")}else{break}}}else if(ver=="check"){for(var i=1;i<29;i++){if(now_days>=i){$("#day-"+i).addClass("is-active")}else{break}}}};var checkSigninStatus=function(callback){$.ajax({url:"/ajax/signin.php",method:"post",data:{action:2},dataType:"json",cache:false}).done(callback)};var signinWork=function(callback){getCsrfToken().done(function(token){$.ajax({url:"/ajax/signin.php",method:"post",data:{action:1,token:token},dataType:"json",cache:false}).done(callback)})};var signinSuccessAnime=function(){setTimeout(function(){$(".before-active").addClass("is-active")},850);progressAnime();if(dialog.length>0){bonusAnime()}};this.showSigninMap=function(element){openSigninMap(element,"check")};this.load=function(){var gold=100;var content='<i class="material-icons">check</i>簽到 + '+gold+" 巴幣";if(BAHAID!==""){checkSigninStatus(function(res){if(res.error!==undefined){if(res.error.code===401){content='<i class="material-icons">check</i>簽到 + '+gold+" 巴幣"}}else if(res.data!==undefined){var signin=parseInt(res.data.signin,10);if(signin===0){content='<i class="material-icons">check</i>簽到 + '+gold+" 巴幣";content+='<p class="check-text">已連續簽到 '+res.data.days+" 天</p>"}else{total_days=res.data.days;now_days=total_days%28;if(now_days===0){now_days=28}$("#signin-btn").addClass("is-active");$("#signin-btn").attr("onclick","Signin.showSigninMap(this);");content='<i class="material-icons">check_box</i>每日簽到已達成'}finishedAd=parseInt(res.data.finishedAd,10)}$("#signin-btn").html(content)})}else{$("#signin-btn").html(content)}};this.start=function(element){if($(".bonus-card-mask").length){$(".bonus-card-mask").remove()}signinWork(function(res){if(res.error!==undefined){if(res.error.code===401){location.href="https://user.gamer.com.tw/login.php"}else{alert(res.error.message)}}else{total_days=res.data.days;now_days=total_days%28;if(now_days===0){now_days=28}dialog=res.data.dialog;openSigninMap(element,"act");signinSuccessAnime();$("#signin-btn").addClass("is-active");$("#signin-btn").attr("onclick","Signin.showSigninMap(this);");$("#signin-btn").html('<i class="material-icons">check_box</i>每日簽到已達成')}})};this.mobile=function(element){checkSigninStatus(function(res){if(res.error!==undefined){if(res.error.code===401){location.href="https://user.gamer.com.tw/login.php"}}else if(res.data!==undefined){finishedAd=parseInt(res.data.finishedAd,10);var signin=parseInt(res.data.signin,10);if(signin===0){if($(".bonus-card-mask").length>0){$(".bonus-card-mask").remove()}signinWork(function(res2){if(res2.error!==undefined){if(res2.error.code===401){location.href="https://user.gamer.com.tw/login.php"}else{alert(res2.error.message)}}else if(res2.data!==undefined){total_days=res2.data.days;now_days=total_days%28;if(now_days===0){now_days=28}dialog=res2.data.dialog;openSigninMap(element,"act");signinSuccessAnime()}})}else{total_days=res.data.days;now_days=total_days%28;if(now_days===0){now_days=28}openSigninMap(element,"check")}}})};this.finishAd=function(){finishedAd=1}};window.Signin=new Signin})(jQuery,window);