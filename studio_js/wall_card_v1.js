(function(window,$,Cookies){"use strict";var card={};card.followFanspage=function(fanspageId,from){var vcode=getRandomVcode();Cookies.set("ckAPP_VCODE",vcode,{domain:"gamer.com.tw",path:"/"});$.ajax({type:"POST",url:"https://api.gamer.com.tw/ajax/wall/fanspage_follow.php?from="+from,xhrFields:{withCredentials:true},data:{fid:fanspageId,vcode:vcode}}).done(function(json){if(json.error){if(json.error.code==401){if(window.User!==undefined){window.User.Login.requireLogin()}else if(BahamutJs.login!==undefined){BahamutJs.login()}else{showMessage(json.error.message)}}else{showMessage(json.error.message)}}else{$(".article_gamercard .gamecard__follow").addClass("is-active").text("已追蹤")}})};function showMessage(message){if(window.Dialogify){window.Dialogify.alert(message)}else{alert(message)}}function getRandomVcode(){var vcode="";for(var i=0;i<4;i++){vcode+=String(Math.floor(Math.random()*10))}return vcode}function setupFanspageCard(){$(".article_gamercard").click(function(e){var target=$(e.target);var cardElem,fanspageId,from;if(target.hasClass("article_gamercard")){cardElem=target}else{cardElem=target.parents(".article_gamercard")}fanspageId=cardElem.data("fanspage-id");from=cardElem.data("from");if(target.hasClass("gamecard__follow")){if(!target.hasClass("is-active")){if(from.match(/^app_/)&&BahamutJs.wallFollow!==undefined){BahamutJs.wallFollow(fanspageId)}else{card.followFanspage(fanspageId,from)}}e.preventDefault()}else{window.open("https://wall.gamer.com.tw/fanpage.php?sn="+fanspageId);if(from.match(/^app_/)){BahamutJs.fanspageCardClick(fanspageId)}else{window.ga&&window.ga("send","event","其它點擊","GNN新聞","GNN小卡粉絲頁")}}});$(".article_gamercard .gamecard-img").imagefill({runOnce:true,target:"a img"})}function addFanspageCard(data){var cardElem=$(".article_gamercard");if(Array.isArray(data)||!cardElem.length||!$("#wallFanspageCardTemplate").length){return}cardElem.append($("#wallFanspageCardTemplate").html());cardElem.find(".gamecard__background").append('<img src="'+data.cover+'">');cardElem.find(".gamecard-img > a").append('<img src="'+data.propic+'">');cardElem.find(".gamecard-label-name").html(data.title);if(data.checkMark==4){cardElem.find(".gamecard-label-name").append('<span class="tick fa fa-check-circle"></span>')}var followers=data.follow.toFixed(1).replace(/\d(?=(\d{3})+\.)/g,"$&,").replace(/\.0$/,"");cardElem.find(".gamecard-label-people > span").text(followers);var followerList=[];if(Array.isArray(data.follower)){data.follower.forEach(function(u){u=u.toLowerCase();var avatarUrl="https://avatar2.bahamut.com.tw/avataruserpic/"+u.charAt(0)+"/"+u.charAt(1)+"/"+u+"/"+u+"_s.png";followerList.push($('<div class="gamecard__gamer"><a href="javascript:;"><img src="'+avatarUrl+'"></a></div>'));followerList.push(window.document.createTextNode("\n"))});if(followerList.length&&data.follow-5>0){var moreCount=Math.min(data.follow-5,99);followerList.push($('<div class="gamecard__gamer gamecard__gamer-more">+'+moreCount+"</div>"))}}cardElem.find(".gamecard__info").prepend(followerList);if(data.isFollow){cardElem.find(".gamecard__follow").addClass("is-active").text("已追蹤")}else{cardElem.find(".gamecard__follow").text("追蹤")}setupFanspageCard()}function requestFanspageData(id){$.ajax({type:"GET",url:"https://wall.gamer.com.tw/api/fanpage.php",xhrFields:{withCredentials:true},data:{fansId:id}}).done(function(json){if(json.data){addFanspageCard(json.data)}})}$(function(){var cardElem=$(".article_gamercard");if(cardElem.length==0){return}var fanspageId=cardElem.data("fanspage-id");if(cardElem.is(":empty")){if(cardElem.hasClass("lazyload")){cardElem.on("lazybeforeunveil",function(e){requestFanspageData(fanspageId)})}else{requestFanspageData(fanspageId)}}else{setupFanspageCard()}})})(window,jQuery,Cookies);