function showAnnouncement(type){jQuery.ajax({url:globalConfig.apiRoot+"/v1/guild_announcement.php",success:function(result){result=result.data;if(!result.show){return}if(Cookies.get("ck_guildAnnouncement")==result.checksum){return}let setCookieThenHide=`Cookies.set('ck_guildAnnouncement', '${result.checksum}', {expires: 365, path: '/', domain:'.gamer.com.tw'}); jQuery(this).parent().hide();`;if(type==="mobile"){jQuery("body").append(`<div class="alert-fixed alert-info" style="z-index: 101;">\n            <a onclick="${setCookieThenHide}" class="alert-close"><i class="fa fa-times"></i></a>\n            <a class="alert-link" href="${result.link}"><b>${result.title}</b><br>${result.content}</a>\n          </div>`)}else{jQuery("body").append(`<div" class="alert-fixed alert-info">\n            <a onclick="${setCookieThenHide}" class="alert-close"><i class="fa fa-times"></i></a>\n            <p><b>${result.title}</b><br>${result.content}</p>\n            <a class="btn " href="${result.link}" target="_blank">→前往查看</a>\n          </div>`)}}})}function joinGuild(gsn,free){egg.get("/ajax/checkBlacklist.php","gsn="+gsn,function(text){if(guildAjaxError(text)){return}if(text=="DENY"){egg.msgbox("您已被設定為黑名單，無法加入此公會社團。")}else{if(free){joinguildauto(gsn)}else{showjoinguild(gsn)}}})}function showjoinguild(gsn){var content="";content+='<div class="open_win">';content+='<h1 class="open_wintitle"><img src="https://i2.bahamut.com.tw/h1_img.gif" />申請加入</h1>';content+='<div>請填寫自我介紹：(限85字)<br><textarea rows="5" id="GID_txt"></textarea></div>';content+='<p class="open_winbtn"><input type="button" id="GID_action" onclick="joinguild(\''+gsn+'\')" value="送出申請"></p>';content+="</div>";$.lightbox.open(content)}function joinguild(gsn){var txt=$("#GID_txt").val();if(txt.utf8Length()>255){alert("字數限 85 字");return false}getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/guildjoin.php",data:{s:gsn,t:txt,token:token},method:"POST"}).done(r_joinguild)});$("#GID_action").get()[0].disabled=true;$("#GID_action").get()[0].value="處理中..."}function joinguildauto(gsn){getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/guildjoin.php",data:{s:gsn,token:token},method:"POST"}).done(r_joinguild)})}function r_joinguild(xmldoc){$.lightbox.close();var msg=$("MSG",xmldoc).val();var title=$("TITLE",xmldoc).val();var action=$("ACTION",xmldoc).val();if("login"==action){var config={title:title,buttons:egg.msgbox.OK|egg.msgbox.CANCEL,onOk:function(event){location.href="https://user.gamer.com.tw/login.php"},onCancel:function(event){egg.msgbox.close()}}}else{var config={title:title,buttons:egg.msgbox.OK,onOk:function(event){egg.msgbox.close()}}}$.msgbox(msg,config)}function showeditmember(gsn,uid){$.ajax({url:"/ajax/guildmemberM.php",success:function(xmldoc){r_showeditmember(xmldoc,gsn,uid)},param:"s="+gsn+"&u="+uid,method:"POST"})}function r_showeditmember(xmldoc,gsn,uid){var msg=$("MSG",xmldoc).val();var title=$("TITLE",xmldoc).val();var action=$("ACTION",xmldoc).val();if("action"==action){new Dialogify(msg).title(title).buttons([{text:"取消",click:function(){this.close()}},{text:"送出",type:Dialogify.BUTTON_PRIMARY,click:function(){var c=$("[name=Mclass]:checked").val();var l=$("#Mlevel").val();var t=$("#Mtitle").val();var p=$("[name=MP]:checked").val();editmember(gsn,uid,c,l,t,p)}}]).showModal()}else{Dialogify.alert(msg);return false}}function editmember(gsn,uid,c,l,t,p){if(36<t.utf8Length()){Dialogify.alert("字數限12字");return false}if(0>l||99<l){Dialogify.alert("等級區間(0~99)");return false}getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/guildmemberMa.php",data:{s:gsn,u:uid,c:c,l:l,t:t,p:p,token:token},method:"POST"}).done(function(xmldoc){r_editmembera(xmldoc,uid)})})}function r_editmembera(xmldoc,uid){var error=$("MSG",xmldoc).val();if(error){Dialogify.alert(error);return}var level=$("LEVEL",xmldoc).val();var title=$("TITLE",xmldoc).val();$("#level_"+uid).html("LV."+level);$("#title_"+uid).html(title)}function leaveguild(gsn,uid,type){var config={title:"訊息",buttons:egg.msgbox.OK|egg.msgbox.CANCEL,onOk:function(event){leaveguilda(gsn,uid,type)},onCancel:function(event){egg.msgbox.close()}};if(uid.toLowerCase()==$.cookie.get("BAHAID").toLowerCase()){$.msgbox("確定要退出？",config)}else{$.msgbox("確定刪除成員? (貢獻度將歸零)",config)}}function leaveguilda(gsn,uid,type){var params="s="+gsn;if(type){if(0>=egg("input:checkbox[name=cbox_uid\\[\\]]:checked").size()){alert("要刪除誰？");return}params+="&au="+egg("input:checkbox[name=cbox_uid\\[\\]]:checked").val()}else{params+="&u="+uid}egg.msgbox.close();getCSRFToken().done(function(token){params+=`&token=${token}`;$.ajax({url:"/ajax/guildmemberD.php",success:function(txtdoc){if("undefined"===typeof JSON){var objtxt=eval("("+txtdoc+")")}else{var objtxt=JSON.parse(txtdoc)}if("ok"===objtxt["ACTION"]){for(var i=0;i<objtxt["NAME"].length;i++){var element=document.getElementById("tr_"+objtxt["NAME"][i]);if(element!=null)element.parentElement.removeChild(element)}$("#guild_"+gsn).hide();$("input:checkbox[name=cbox_uid\\[\\]]").each(function(elems){elems.checked=false})}alert(objtxt["MSG"])},param:params,cache:false,method:"POST"})})}function checkmember(action){if(0>=$("form :checkbox:checked").size()){alert("請選擇要動作的帳號");return false}$("input[name=a]").val(action);$("[name=formC]").get()[0].submit()}function guildNewAgree(){jQuery.ajax({url:"https://api.gamer.com.tw/guild/v1/guild_create_limit.php",method:"GET",xhrFields:{withCredentials:true}}).done(function(result){if(result.error){Dialogify.alert(result.error.message);return}let permCheckMsg={phone:'須通過<a href="https://user.gamer.com.tw/verify.php" target="_blank" style="color: #0055aa">手機認證</a>',threeMonth:"帳號須註冊滿三個月",noPost:'非<a href="https://user.gamer.com.tw/help/abuse.php" target="_blank" style="color: #0055aa">全站禁貼</a>期間',moreThenThree:"每個帳號最多僅能擔任三個會長職",coin:"建立公會須收費 500 巴幣"};let permTextBox="<style>.perm_icon:before {font: normal normal normal 14px/1 FontAwesome}</style>";permTextBox+="<style>.perm_icon {padding-top: 5px}</style>";permTextBox+='<style>.perm_pass:before {content: "\\f05d"; color: green;}</style>';permTextBox+='<style>.perm_fail:before {content: "\\f05c"; color: red;}</style>';let pass='<i class="perm_icon perm_pass"></i>';let fail='<i class="perm_icon perm_fail"></i>';let permCheck=result.data.permCheck;permTextBox+="<p>"+(permCheck.phone?pass:fail)+` ${permCheckMsg.phone}</p><br>`;permTextBox+="<p>"+(permCheck.threeMonth?pass:fail)+` ${permCheckMsg.threeMonth}</p><br>`;permTextBox+="<p>"+(permCheck.noPost?pass:fail)+` ${permCheckMsg.noPost}</p><br>`;permTextBox+="<p>"+(permCheck.moreThenThree?pass:fail)+` ${permCheckMsg.moreThenThree}</p><br>`;permTextBox+="<p>"+(permCheck.coin?pass:fail)+` ${permCheckMsg.coin}</p>`;if(result.data.pass){themeGuildNew()}else{new Dialogify(permTextBox).title("權限不足").buttons([{type:Dialogify.BUTTON_PRIMARY,click:function(){this.close()}}],{position:Dialogify.BUTTON_CENTER}).showModal()}})}function themeGuildNew(){jQuery.ajax({url:"https://api.gamer.com.tw/ajax/guild/guild_new_theme.php",method:"GET",xhrFields:{withCredentials:true},success:function(content){content=JSON.parse(content);if(content.error){Dialogify.alert(content.error);return}var mask=jQuery("<div></div>");mask.attr("id","dialogify_mask").css({position:"fixed",top:"0px",left:"0px",zIndex:99,backgroundColor:"black",width:"100%",height:"100%",opacity:.7}).click(function(){jQuery(".dialogify.fixed").parent().remove();this.remove()});jQuery("body").append(mask);jQuery("body").append("<style>.buttonReset {width: auto; margin-top: 2px; margin-bottom: 2px;}</style>");new Dialogify(content.data,{useDialogForm:false}).title("申請公會").buttons(['<p class="post__text-small buttonReset" style="float: left;">申請送出同時代表您已同意巴哈姆特<a class="" href="https://user.gamer.com.tw/help/detail.php?sn=393" target="_blank">公會規範</a></p>',{type:"buttonReset",click:function(){this.close()}},{text:"送出",type:Dialogify.BUTTON_PRIMARY+" buttonReset",click:function(){if(submitCheck()&&confirm("確定送出?")){document.frmNew.submit()}}}],{position:Dialogify.BUTTON_RIGHT}).on("close",()=>{jQuery("#dialogify_mask").remove()}).show();jQuery(".dialogify.fixed").wrap('<div id="guild_create_dialogify"></div>')}})}function join_guildflag(gsn,jtype){getCSRFToken().done(function(token){$.ajax({url:"/ajax/setGuildflag.php",success:function(filldata){$.lightbox.close();rmsg=filldata?filldata:"系統忙碌中";var config={height:60,width:400,title:"訊息",buttons:egg.msgbox.YES,onYes:function(event){$.msgbox.close()}};$.msgbox(rmsg,config)},param:"sn="+gsn+"&t="+jtype+"&token="+token,method:"POST"})})}function wallOption(item,checked){var bool=checked?1:0;var cookie=egg.cookie.get("ckWallOption");if(!cookie){cookie="000"}switch(item){case"guildPrivacy":cookie=bool+cookie.substr(1);egg.cookie.set("ckWallOption",cookie,".gamer.com.tw","/",30);break;default:}}function newBlacklist(gsn){var uid=egg("#bl_id").val();if(!uid.match(/^[A-Za-z][A-Za-z0-9]{1,11}$/)){egg.msgbox("請輸入正確使用者帳號")}getCSRFToken().done(function(token){var data={gsn:gsn,u:uid,token:token};jQuery.post("/ajax/manageBlacklist.php",data,function(text){if(guildAjaxError(text)){return}egg("#divBlacklist").html(text)})})}function delBlacklist(btn,gsn,uid){egg.msgbox("此人將從黑名單中移除，請問是否確定？",{buttons:egg.msgbox.OK|egg.msgbox.CANCEL,onOk:function(){egg.msgbox.close();if(!uid.match(/^[A-Za-z][A-Za-z0-9]{1,11}$/)){egg.msgbox("請輸入正確使用者帳號")}getCSRFToken().done(function(token){var data={gsn:gsn,del:"yes",u:uid,token:token};jQuery.post("/ajax/manageBlacklist.php",data,function(text){if(guildAjaxError(text)){return}var tr=btn.parentNode.parentNode;try{tr.parentNode.removeChild(tr)}catch(e){}})})},onCancel:function(){egg.msgbox.close()}})}function guildAjaxError(err){var error=true;switch(err){case"ERR_USER_EXISTS":egg.msgbox("此人已在黑名單中");break;case"ERR_QUERY":egg.msgbox("資料查詢錯誤");break;case"ERR_PARAM":egg.msgbox("參數錯誤");break;case"ERR_PERM":egg.msgbox("您無此權限");break;case"ERR_BLACKLIST_SELF":egg.msgbox("無法將自己加入黑名單中!");break;case"ERR_BLACKLIST_MASTER":egg.msgbox("無法將會長加入黑名單中!");break;case"ERR_USER_NOTEXISTS":egg.msgbox("無此帳號~");break;case"ERR_NOLOGIN":egg.msgbox("請先登入");break;case"ERR_LOCK":egg.msgbox("已被凍結，無法使用!");break;case"ERR_NODEPOSIT":egg.msgbox("金額不足：所持巴幣不足！");break;case"ERR_ADDONS_EXISTS":egg.msgbox("已購買過該項功能");break;case"ERR_ADDONS_NOEXISTS":egg.msgbox("請先購買該項功能");break;case"ERR_OTHER":egg.msgbox("發生不明原因失敗，請稍候再試!");break;case"ERR_ABUSE":egg.msgbox("已被全站禁貼，無法執行此動作!");break;case"ERR_FULL":egg.msgbox("很抱歉，由於名額已滿，請於明日再嘗試購買。");break;case"ERR_MEMBER":egg.msgbox("成員人數未達標準。");break;case"ERR_EM":egg.msgbox("請先購買上一級的自訂表情");break;case"ERR_RANK":egg.msgbox("公會等級不足");break;case"ERR_TOKEN":egg.msgbox("網頁已經過期，請重新整理頁面");break;default:error=false}return error}function guildbuyAddOns(gsn,addons_no){egg.msgbox("注意！購買後將無法退還，購買前請先了解功能內容！<br>確定要購買此功能？",{buttons:egg.msgbox.OK|egg.msgbox.CANCEL,width:"385",height:"55",onOk:function(){egg.msgbox.close();getCSRFToken().done(function(token){jQuery.post("/ajax/addonsNew.php?gl="+gsn+"&al="+addons_no,{gsn:gsn,addons:addons_no,token:token},function(text){if(guildAjaxError(text)){return}if(2==addons_no){egg.msgbox("感謝您的購買！廣告將於 24:00 於公會大廳播放！",{width:"320px",height:"20px"})}else if(3==addons_no){egg.msgbox("感謝您的購買！您可至會旗設定處進行設定！",{width:"320px",height:"20px"})}egg("#con_surplus").html(parseInt(egg("#con_surplus").html(),10)-parseInt(text,10));egg("#addons_"+addons_no).html("已購買")})})},onCancel:function(){egg.msgbox.close()}})}function GUILD_makeCalendar(gsn,year,month,active,edit){var days=new Array(31,28,31,30,31,30,31,31,30,31,30,31);var today=new Date;var theMonth=new Date;theMonth.setFullYear(year,month-1,1);loopbefore=theMonth.getDay();looptotal=days[month-1];if(month==2&&(year%400==0||year%4==0&&year%100!=0)){looptotal=29}var ob_str="";ob_str+='<p><a href="javascript:void(0)" onclick="GUILD_changeCalendar(\''+gsn+"','"+year+"','"+month+'\',\'-1\')" class="MSG-list5A"></a><a href="javascript:void(0)" onclick="GUILD_changeCalendar(\''+gsn+"','"+year+"','"+month+"','1')\" class=\"MSG-list5B\"></a>"+year+" 年 "+month+" 月</p>";ob_str+='<table class="BH-table TB2">';ob_str+='<tr class="TBC2">';ob_str+="<td>日</td>";ob_str+="<td>一</td>";ob_str+="<td>二</td>";ob_str+="<td>三</td>";ob_str+="<td>四</td>";ob_str+="<td>五</td>";ob_str+="<td>六</td>";ob_str+="</tr>";if(loopbefore>0){ob_str+="<tr>"}for(i=0;i<loopbefore;i++){ob_str+="<td>&nbsp;</td>"}if(month<10){month0="0"+month}else{month0=month}for(i=1;i<=looptotal;i++){var bgc="";var bgc2=' class="MSG-list5C"';if(today.getDate()==i&&today.getFullYear()==theMonth.getFullYear()&&today.getMonth()==theMonth.getMonth()){bgc=' class="MSG-list5D"';bgc2=' class="MSG-list5D"'}if(1==(loopbefore+i)%7){ob_str+="<tr>"}if(i<10){day0="0"+i}else{day0=i}if(active.indexOf(","+day0+",")>=0){ob_str+="<td"+bgc+"><a"+bgc2+' href="javascript:;" onclick="GUILD_CalendarDetail(\''+gsn+"','"+year+month0+day0+"')\">"+i+"</a></td>"}else{theMonth.setDate(i);if(1==edit){ob_str+="<td"+bgc+'><a href="javascript:;" onclick="GUILD_CalendarAdd(\''+gsn+"','"+year+month0+day0+"')\">"+i+"</a></td>"}else{ob_str+="<td"+bgc+">"+i+"</td>"}}if(0==(loopbefore+i)%7){ob_str+="</tr>"}}if(0!=(loopbefore+i-1)%7){for(i=7-(loopbefore+i-1)%7;i>0;i--){ob_str+="<td>&nbsp;</td>"}}ob_str+="</tr></table>";$("#CALENDAR_CONTENT").html(ob_str)}function GUILD_CalendarAdd(gsn,date){var button={"儲存":function(){GUILD_CalendarSave(gsn,date,1)}};var day=new Date(date.substr(0,4),parseInt(date.substr(4,2),10)-1,date.substr(6,2));var week=["日","一","二","三","四","五","六"];egg.mutbox("<p>日期："+date.substr(0,4)+"-"+date.substr(4,2)+"-"+date.substr(6,2)+" 星期"+week[day.getDay()]+'</p><p>內容：<span class="BH-tcolor4">(限200字)</span></p><textarea id="C_content" class="txtin"></textarea>',"行事曆",button);egg.mutbox.option({css:{"text-align":"left",width:"450px"}});egg.mutbox.refresh()}function GUILD_CalendarDetail(gsn,date){egg.ajax({url:"/ajax/guildCalendarDetail.php",param:"gsn="+gsn+"&d="+date,method:"POST",success:function(txt){var data=eval("("+txt+")");if(0==data.ok){var config={title:"系統訊息"};egg.msgbox(data.msg,config);return}if(data.edit){var button={"編輯":function(ext){GUILD_CalendarEdit(gsn,date)},"刪除":function(ext){if(confirm("確定要刪除？")){GUILD_CalendarDel(gsn,date)}}}}egg.mutbox("<p>日期："+data.date+'</p> <p>內容：</p> <p class="txt">'+data.content+'</p> <p class="date">最後編輯：'+data.userid+"</p>","行事曆",button);egg.mutbox.option({css:{"text-align":"left",width:"450px"}});egg.mutbox.refresh()}})}function GUILD_CalendarEdit(gsn,date){egg.ajax({url:"/ajax/guildCalendarDetail.php",param:"gsn="+gsn+"&d="+date,method:"POST",success:function(txt){egg.lightbox.close();var data=eval("("+txt+")");if(0==data.ok){var config={title:"系統訊息"};egg.msgbox(data.msg,config);return}if(data.edit){var button={"儲存":function(ext){GUILD_CalendarSave(gsn,date,2)}}}data.content=data.content.replace(/<br \/>/g,"");egg.mutbox("<p>日期："+data.date+'</p><p>內容：<span class="BH-tcolor4">(限200字)</span></p><textarea id="C_content" class="txtin">'+data.content+"</textarea>","行事曆",button);egg.mutbox.option({css:{"text-align":"left",width:"450px"}});egg.mutbox.refresh()}})}function GUILD_CalendarSave(gsn,date,type){getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/guildCalendarC.php",data:{gsn:gsn,d:date,type:type,content:jQuery("#C_content").val(),token:token},method:"POST"}).done(function(txt){var data=eval("("+txt+")");var config={title:"系統訊息"};if(0==data.ok){egg.msgbox(data.msg,config);return}else if(1==data.ok){GUILD_changeCalendar(gsn,date.substr(0,4),date.substr(4,2),0);egg.msgbox("儲存成功",config);egg.lightbox.close();return}else{egg.msgbox("系統忙碌，請稍後再試。",config);return}})})}function GUILD_changeCalendar(gsn,y,m,offset){m=parseInt(m,10);y=parseInt(y,10);offset=parseInt(offset,10);m+=offset;if(m<1){y-=1;m=12}else if(m>12){y+=1;m=1}$.ajax({url:"/ajax/guildCalendar.php",success:GUILD_r_changeCalendar,param:"gsn="+gsn+"&y="+y+"&m="+m,method:"POST"})}function GUILD_r_changeCalendar(txt){var data=eval("("+txt+")");if(0==data.ok){var config={title:"系統訊息"};egg.msgbox(data.msg,config)}GUILD_makeCalendar(data.gsn,data.y,data.m,data.active,data.edit)}function GUILD_CalendarDel(gsn,date){getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/guildCalendarC.php",data:{gsn:gsn,d:date,type:3,token:token},method:"POST"}).done(function(txt){var data=eval("("+txt+")");var config={title:"系統訊息"};if(0==data.ok){egg.msgbox(data.msg,config);return}else if(1==data.ok){GUILD_changeCalendar(gsn,date.substr(0,4),date.substr(4,2),0);egg.msgbox("刪除成功",config);egg.lightbox.close();return}else{egg.msgbox("系統忙碌，請稍後再試。",config);return}})})}function editguildem(){var content="";var data=guildEmotions;for(i=0;i<guildEmotions_count;i++){if(typeof data[i]!="undefined"){content+='<p style=" display:inline-block; font-size:13px; line-height:16px; margin:0 3px 7px 0; width:90px;"><span style="display:block; width:32px; height:32px; text-align:center; float:left; margin-right:5px;"><img src="https://p2.bahamut.com.tw/B/GUILD/e/'+gsn%10+"/"+data[i]["pic"]+'"/></span>'+data[i]["title"]+'<a href="javascript:;" style="display:block; color:#3e81c6;" onclick="delemotion(\''+gsn+"','"+data[i]["code"]+"');\">刪除</a></p>"}else{content+='<p style=" display:inline-block; font-size:13px; line-height:16px; margin:0 3px 7px 0; width:90px;"><img src="https://i2.bahamut.com.tw/guild/noemotion.gif" style="float:left; margin-right:5px;" />未設定<a href="javascript:;" style="display:block; color:#3e81c6;" onclick="upemotion('+i+')">上傳</a></p>'}}content+='<form action="guildemoticons.php" method="post" target="delIframe" name="delform"><input type="hidden" id="delgsn" name="gsn" value=""><input type="hidden" name="a" value="D"><input type="hidden" id="delc" name="c" value=""></form>';content+='<iframe name="delIframe" id="delIframe" style="display:none;"></iframe>';content+='<div id="updiv" style="padding:10px 0 0 0; font-size:13px; margin-top:5px; border-top:1px solid #CCCCCC;display:none">';content+="上傳圖像：<br />";content+='<form action="guildemoticons.php" method="post" enctype="multipart/form-data" target="upIframe">';content+='<input type="hidden" name="s" id="sort" value="">';content+='<input type="hidden" name="gsn" value="'+gsn+'">';content+='<input type="hidden" name="a" value="A">';content+='<p style=" display:inline-block; margin-right:10px;">1. <input name="pic" type="file" style="height:25px; vertical-align:middle;width:150px" size="10" /><img name="qa" class="IMG-E04" style=" margin-left: 3px;" src="https://i2.bahamut.com.tw/spacer.gif" title="接受jpg、png、gif 圖片格式，圖片限 32x32、50k 以下。"/></p>';content+='<p style=" display:inline-block; margin-right:10px;">2. 填寫描述：<input name="d" type="text" style="height:18px; vertical-align:middle; width:70px;" /><img name="qa" class="IMG-E04" style=" margin-left: 3px;" src="https://i2.bahamut.com.tw/spacer.gif" title="說明圖片內容，如大笑、哭泣等...，限5字，不可重複。"/></p>';content+='<p style=" display:inline-block;">3. <button style="line-height:18px; margin-left:3px; vertical-align:middle;" type="submit">開始上傳</button></p>';content+='<iframe name="upIframe" id="upIframe" style="display:none;"></iframe>';content+="</form></div>";egg.lightbox.close();egg.mutbox(content,"設定表情");egg.mutbox.option({css:{"text-align":"left",width:"775px"}});egg.mutbox.refresh();$("[name=qa]").tooltip({css:{"max-width":"165px","font-size":"12px",padding:"5px","background-color":"#fffad2",border:"1px solid #b46600"}})}function delemotion(gsn,c){$("#delgsn").val(gsn);$("#delc").val(c);$("[name=delform]").get(0).submit()}function upemotion(s){$("#updiv").show();$("#sort").val(s)}function all_showEmotion(button,text){if(""!=$("#emotionlist").get()){$("#emotionlist").removeFrom(document.body);return}var div=document.createElement("div");$(div).attr("id","emotionlist");$(div).hide();$(div).appendTo(document.body);var table="";var tagNow_default="";var tagNow_custom1="";var tagNow_custom2="";if(typeof guildEmotions!="undefined"){if(guildEmotions_count<=30){if(0==guildEmotions_type){tagNow_default="BH-master_tag1now";tagNow_custom1=""}else{tagNow_default="";tagNow_custom1="BH-master_tag1now"}table+='<ul class="BH-master_tag1"><li><a href="javascript:;" onclick="guildEmotions_type=0;all_showEmotion(\''+button+"','"+text+"');all_showEmotion('"+button+"','"+text+'\')" class="'+tagNow_default+'">預設表情</a></li><li><a href="javascript:;" onclick="guildEmotions_type=1;all_showEmotion(\''+button+"','"+text+"');all_showEmotion('"+button+"','"+text+'\')" class="'+tagNow_custom1+'">自訂表情</a></li></ul>'}else{if(0==guildEmotions_type){tagNow_default="BH-master_tag1now";tagNow_custom1="";tagNow_custom2=""}else if(guildEmotions_type==1){tagNow_default="";tagNow_custom1="BH-master_tag1now";tagNow_custom2=""}else{tagNow_default="";tagNow_custom1="";tagNow_custom2="BH-master_tag1now"}table+='<ul class="BH-master_tag1"><li><a href="javascript:;" onclick="guildEmotions_type=0;all_showEmotion(\''+button+"','"+text+"');all_showEmotion('"+button+"','"+text+'\')" class="'+tagNow_default+'">預設表情</a></li><li><a href="javascript:;" onclick="guildEmotions_type=1;all_showEmotion(\''+button+"','"+text+"');all_showEmotion('"+button+"','"+text+'\')" class="'+tagNow_custom1+'">自訂表情</a></li><li><a href="javascript:;" onclick="guildEmotions_type=2;all_showEmotion(\''+button+"','"+text+"');all_showEmotion('"+button+"','"+text+'\')" class="'+tagNow_custom2+'">自訂表情2</a></li></ul>'}}if(0==guildEmotions_type||typeof guildEmotions=="undefined"){table+="<table><tr>";for(i=1;i<=11;i++){table+='<td><a href="javascript:void(0)" onclick="all_addEmotion(\'e'+i+"','"+text+'\')"><img src="https://i2.bahamut.com.tw/editor/emotion/'+i+'.gif" /></a></td>'}table+="</tr><tr>";for(i=12;i<=23;i++){table+='<td><a href="javascript:void(0)" onclick="all_addEmotion(\'e'+i+"','"+text+'\')"><img src="https://i2.bahamut.com.tw/editor/emotion/'+i+'.gif" /></a></td>'}table+="</tr><tr>";for(i=24;i<=33;i++){table+='<td><a href="javascript:void(0)" onclick="all_addEmotion(\'e'+i+"','"+text+'\')"><img src="https://i2.bahamut.com.tw/editor/emotion/'+i+'.gif" /></a></td>'}table+="</tr><tr>";for(i=34;i<=43;i++){table+='<td><a href="javascript:void(0)" onclick="all_addEmotion(\'e'+i+"','"+text+'\')"><img src="https://i2.bahamut.com.tw/editor/emotion/'+i+'.gif" /></a></td>'}table+="</tr></table>"}else{table+='<div style="width:337px">';if(guildEmotions_type==1){var maxSn=48;var j=0;var forBegin=0}else{var maxSn=96;var j=48;var forBegin=48}if(guildEmotions_count>maxSn)guildEmotions_count_limit=maxSn;else guildEmotions_count_limit=guildEmotions_count;for(i=forBegin;i<guildEmotions_count_limit;i++){if(typeof guildEmotions[i]!="undefined"){if(j!=0&&j%8==0){table+='<br style="clear:both">'}table+='<div style="margin:5px;width:32px;float:left" align="center"><a href="javascript:void(0)" onclick="all_addEmotion(\'G'+guildEmotions[i]["code"]+"','"+text+'\')"><img src="https://p2.bahamut.com.tw/B/GUILD/e/'+gsn%10+"/"+guildEmotions[i]["pic"]+'" title="'+guildEmotions[i]["title"]+'"/></a></div>';j++}}if(forBegin==j){table+='<div align="center">尚未設定</div>'}if(typeof guildmaster!="undefined"){table+='<br style="clear:both"><div align="right"><a href="javascript:;" onclick="all_showEmotion(\''+button+"','"+text+"');editguildem()\">設定</a></div>"}table+="</div>"}$("#emotionlist").html(table);var pos=$("#"+button).pos();$("#emotionlist").css("left",pos.x+"px");$("#emotionlist").css("top",pos.y+20+"px");$("#emotionlist").show()}function all_addEmotion(esn,sn){if("reply0"==sn){creation_reply_default()}$("#emotionlist").removeFrom(document.body);var str="["+esn+"] ";var textBox=$("#"+sn).get()[0];if(document.selection){textBox.focus();document.selection.createRange().text=str+document.selection.createRange().text}else{var st=textBox.selectionStart;var pre=textBox.value.substr(0,textBox.selectionStart);var post=textBox.value.substr(textBox.selectionEnd);textBox.value=pre+str+post;textBox.focus();textBox.setSelectionRange(st+str.length,st+str.length)}}var guildEmotions_type=0;function wikihideMenu(t){egg("#wikiCatelog").css("display",t?"none":"")}function wikiMenuShowCTR(divid,thisImg){egg("#"+divid).css("display",egg("#"+divid).css("display")?"":"none");thisImg.src=egg("#"+divid).css("display")?"https://i2.bahamut.com.tw/wiki/c_icon01.gif":"https://i2.bahamut.com.tw/wiki/c_icon02.gif"}function accuseWikins(sn,hsn){var wikiaccusehtml="";wikiaccusehtml+='檢舉理由：<select id="wikiAccuseReason"><option selected="selected" value="0">-請選擇理由-</option>';wikiaccusehtml+='<option value="1">含有盜版或限制級內容</option>';wikiaccusehtml+='<option value="2">進行商業廣告或交易</option>';wikiaccusehtml+='<option value="3">侵害著作權、個人隱私</option>';wikiaccusehtml+='<option value="4">進行人身攻擊、洗板</option>';wikiaccusehtml+='<option value="5">其他</option></select><br />';wikiaccusehtml+='<input type="text" placeholder="請輸入檢舉理由" id="wikiAccuseOtherReason" style="padding:3px;width:300px;" />';egg.mutbox(wikiaccusehtml,"檢舉",{"確定":function(){accuseWikinssend(sn,hsn)},"取消":function(){egg.lightbox.close()}},{closeButton:false});egg.mutbox.option("width","350px");egg.mutbox.option({css:{"text-align":"left"}})}function accuseWikinssend(sn,hsn){if(!egg.cookie.get("BAHAID")){if(confirm("您需要先登入才能使用此項功能喔")){location.href="https://user.gamer.com.tw/login.php"}return}var sltReason=egg("#wikiAccuseReason").get(0);var selected=sltReason.selectedIndex;if(selected==0){alert("請選擇理由");return}var reason=egg("#wikiAccuseOtherReason").val();var greason=sltReason.options[selected].text;reason=reason.replace(/[ 　]/g,"");greason=greason.replace(/[ 　]/g,"");if(!greason||greason.length>10){alert("請選擇檢舉理由");return}if(!reason||reason.length>50){alert("請填寫原因(50字內)");return}if(confirm("確定送出檢舉?")){reason=encodeURIComponent(reason);greason=encodeURIComponent(greason);egg.post("/ajax/wikiAccuse.php","sn="+sn+"&hsn="+hsn+"&r="+reason+"&gr="+greason,function(txtdoc){if("undefined"===typeof JSON){var objtxt=eval("("+txtdoc+")")}else{var objtxt=JSON.parse(txtdoc)}if("ok"==objtxt["status"]){egg.lightbox.close();alert("檢舉已送出")}else{alert(objtxt["msg"])}})}}function GUILD_resign(gsn,gtitle){egg.ajax({url:"/ajax/checkResignGM_AJAX.php",method:"POST",param:"gsn="+gsn+"&resign_reason="+egg("#resign_reason").val(),cache:false,success:function(txt){if(txt!=""){egg.msgbox(txt);return}else{GUILD_resign_action1(gsn,gtitle)}}})}function GUILD_resign_action1(gsn,gtitle){var content='<table style="width:100%; border:3px solid #e5e5e5;">';content+="  <tr>";content+='    <td style="padding:5px; border:1px solid #e5e5e5;text-align:center; background-color:#f6f6f6; white-space:nowrap;">公會名稱</td>';content+='    <td style="padding:5px; border:1px solid #e5e5e5;">'+gtitle+"</td>";content+="  </tr>";content+="  <tr>";content+='    <td style="padding:5px; border:1px solid #e5e5e5;text-align:center; background-color:#f6f6f6; white-space:nowrap;">卸任原因</td>';content+='    <td style="padding:5px; border:1px solid #e5e5e5;"><textarea cols="35" rows="5" id="resign_reason"></textarea><br /><font color="red">「此請辭申請書內容將一併通知貴公會全員」</font></td>';content+="  </tr>";content+="  </table>";egg.mutbox(content,"申請卸任",{"確定":function(){GUILD_resign_action2(gsn)},"取消":function(){egg.lightbox.close()}},{closeButton:false});egg.mutbox.option("width","450px");egg.mutbox.option({css:{"text-align":"left"}})}function GUILD_resign_action2(gsn){if(""==egg("#resign_reason").val()){egg.msgbox("請填原因");return}if(confirm("是否確認送出申請？")){egg.ajax({url:"/ajax/resignGM_AJAX.php",method:"POST",param:"gsn="+gsn+"&resign_reason="+egg("#resign_reason").val(),cache:false,success:function(txt){egg.lightbox.close();egg.msgbox(txt)}})}}function guildwiki_push_form(isopen,sn,wikititle){if(!egg.cookie.get("BAHAID")){if(confirm("您需要先登入才能使用此項功能喔。")){location.href="https://user.gamer.com.tw/login.php"}return}if(1!=isopen){alert("本Wiki設定為不公開，無法進行推薦。");return}var content='推薦後就有機會讓此作品在首頁曝光！<br />請填寫推薦理由（限 85 字）：<br><textarea rows="5" cols="30" id="push_memo"></textarea>';egg.bahabox(content,"推上精選公會Wiki",{"確定送出":function(){guildwiki_push(sn,wikititle)}})}function guildwiki_push(sn,wikititle){var push_reason=$("#push_memo").val();if("255"<push_reason.utf8Length()){alert("字數超過 85 個字");return}if(0>=push_reason.utf8Length()){alert("請填寫推薦理由");return}$.lightbox.close();getCSRFToken().done(function(token){jQuery.ajax({url:"/ajax/wikiPush.php",method:"POST",data:{sn:sn,wt:wikititle,r:push_reason,token:token}}).done(function(txtdoc){var objtxt=JSON.parse(txtdoc);egg.lightbox.close();alert(objtxt["msg"])})})}function getCSRFToken(){return jQuery.ajax({url:"/ajax/getCSRFToken.php",cache:false})}function GUILD_giftAvatar(f){if(f.url.value==""){alert("請輸入勇造網址");return false}else if(f.account.value==""){alert("請輸入成員帳號");return false}else{var gsn=f.gsn.value;var url=f.url.value;var account=f.account.value;var a=0;var ct=f.ct.value;account=account.split("\n");countAccount=account.length;if(countAccount==0){alert("訊息: 送禮人數有誤，請重新確認人數!");return false}else if(countAccount>50){alert("訊息: 送禮人數超過 50 人，請重新確認人數!");return false}egg.ajax({url:"/ajax/checkGiftAvatar.php",method:"get",async:"SYNC",data:"url="+url+"&gsn="+gsn+"&ct="+ct,success:function(text){a=GUILD_giftAvatarSend(text,countAccount)}})}if(a==1)return true;else return false}function GUILD_giftAvatarSend(p,c){var con=parseInt(egg("#con_surplus").html(),10);if(p==parseInt(p,10)){p=parseInt(p,10);c=parseInt(c,10);if(con<p*c){alert("訊息: 公會金庫資金不足，請重新確認發送名額!");return 0}else{if(confirm("發送勇造給 "+c+" 位成員，共消費 "+p*c+" 資金\n是否確定? (消費後無法退還)"))return"1";else return"0"}}else{alert("訊息: "+p);return 0}}function guild_sign(sn){egg.ajax({url:"/ajax/guildSign.php",method:"POST",param:"sn="+sn,success:function(rjson){var data=JSON.parse(rjson);alert(data.msg)}})}function beta(quit){if(quit){Cookies.remove("ckGuildBeta",{path:"/",domain:".guild.gamer.com.tw"})}else{Cookies.set("ckGuildBeta","yes",{expires:365,path:"/",domain:".guild.gamer.com.tw"})}window.location.reload()}function legacy(legacy){if(legacy){Cookies.set("ckGuildLegacy","yes",{expires:365,path:"/",domain:".guild.gamer.com.tw"})}else{Cookies.remove("ckGuildLegacy",{path:"/",domain:".guild.gamer.com.tw"})}window.location.reload()}(function(window,$,Cookies){"use strict";var LastBrowse={MAX_SHOW:10,getData:function(){var lastBrowseRawData=Cookies.get("ckGUILD_lastBrowse")||"";if(lastBrowseRawData===""){return null}try{return JSON.parse(lastBrowseRawData).map(function(guildData){if(!guildData[0].match(/^[0-9]+$/)){return null}return[guildData[0],guildData[1]]}).filter(function(e){return e})}catch(err){return null}},addBrowse:function(gsn,guildTitle){var newLastBrowse=[],lastBrowse=this.getData(),tmp=null;newLastBrowse.push([gsn,guildTitle]);if(lastBrowse){while(tmp=lastBrowse.shift()){if(tmp[0]===gsn){continue}newLastBrowse.push(tmp)}}Cookies.set("ckGUILD_lastBrowse",JSON.stringify(newLastBrowse.slice(0,this.MAX_SHOW)),{domain:"gamer.com.tw",path:"/",expires:14})},renderList:function(containerId){var lastBrowse=this.getData(),$container=$("#"+containerId);if(!lastBrowse){$container.html('<div style="padding:8px;">無。</div>')}else{$container.html("<ul></ul>");for(var i=0;i<this.MAX_SHOW&&lastBrowse[i];i++){var row=lastBrowse[i];row[1]=row[1].replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");$container.children().append('<li><a href="//guild.gamer.com.tw/guild.php?gsn='+row[0]+'">'+row[1]+"</a></li>")}}}};window.Guild=window.Guild||{};window.Guild.LastBrowse=LastBrowse})(window,jQuery,Cookies);